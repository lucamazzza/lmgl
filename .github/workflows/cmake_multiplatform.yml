name: Build and Test

on:
  push:
    branches: [ main, dev ]
    tags:
      - 'v*'
  pull_request: 
    branches: [ main, dev ]

jobs:
  build: 
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix: 
        config:
          - name: Ubuntu latest GCC
            os: ubuntu-latest
            cc: gcc
            cxx: g++

          - name: macOS latest clang
            os: macos-latest
            cc: clang
            cxx: clang++

          - name: Windows latest MSVC
            os: windows-latest
            cc: cl
            cxx: cl

    steps:
    - name: Checkout repository
      uses:  actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libglfw3-dev \
          libgl1-mesa-dev \
          xorg-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          cmake \
          build-essential

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew update
        brew install glfw cmake

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'

    - name: Setup vcpkg (Windows)
      if: runner.os == 'Windows'
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat
        .\vcpkg\vcpkg install glfw3:x64-windows
      shell: cmd
    
    - name: Configure CMake (Linux)
      if: runner.os == 'Linux'
      env:
        CC: ${{ matrix.config.cc }}
        CXX: ${{ matrix.config.cxx }}
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DHEADLESS=ON

    - name: Configure CMake (macOS)
      if: runner.os == 'macOS'
      env: 
        CC: ${{ matrix.config.cc }}
        CXX: ${{ matrix.config.cxx }}
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DHEADLESS=ON

    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      env:
        CC: ${{ matrix.config.cc }}
        CXX: ${{ matrix.config.cxx }}
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DHEADLESS=ON -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake

    - name: Build
      run: cmake --build build --config Release

    - name: Test
      working-directory: build
      run: ctest -C Release --output-on-failure

    - name: Package
      run: cmake --build build --config Release --target package

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lmgl-${{ matrix.config.os }}-${{ github.sha }}
        path: |
          build/*.zip
          build/*.tar.gz
          Sandbox
          Sandbox.exe
        retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github. ref, 'refs/tags/v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with: 
          path: artifacts

      - name: Create Release
        uses:  softprops/action-gh-release@v1
        with: 
          files: artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
